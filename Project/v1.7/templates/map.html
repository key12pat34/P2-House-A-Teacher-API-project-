<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <title>House-A-Teacher Map</title>
      
        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin="" />
        
       

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

        <!-- Our CSS -->
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='map.css') }}">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>

    <body>
        <!-- Navigation bar -->
        <!--START Nav Bar-->
        <nav class="navbar navbar-expand-md bg-dark navbar-dark">
            <a class="navbar-brand">
            <img src="../assets/images/logo.png" width="150" height="80" alt="">
            </a>
            <!-- <a class="navbar-brand">House-A-Teacher</a> -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
            <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="collapsibleNavbar">
            <ul class="navbar-nav">
        
                </li>
                <li class="nav-item">
                <a class="nav-link" href=homepage.html>Home</a>
                </li>
                <li class="nav-item">        
                <a class="nav-link" href="map.html">Map</a>
                </li>
            </ul>
            </div>  
        </nav>
        <!--END Nav Bar-->
        <!-- <script src="//code.jquery.com/jquery.min.js"></script> -->
        <script>$.get("navbar.html", function(data){$("#nav-placeholder").replaceWith(data);});</script>
        
        <h1>Interactive Map</h1>
        <p>Use the map below to select houses for sale and nearby school information.</p>

        <!-- The div where we will inject our map and form -->
    
        <div id ="form">
            <div class=centerbutton>
            <form class="form inline">
            <div class="container">
                <div class="row">
                    <div class="col">
                        <aside class="filters">
                            <div class="panel">
                                <div class="panel"><h1>Filter Search</h1></div>
                                    <div class="panel">
                                        <div class="form">
                                            <ul class="list" id="filters">
                                                <li class="filter list-group-item">
                                                <label for="limit">Max Number of Results</label>
                                                <input class="form-control" id="limit" type="text" placeholder="100">
                                                <label for="city">Enter a City in Georgia</label>
                                                <input class="form-control" id="city" type="text" placeholder="Atlanta">
                                                <label for="state">Enter a Max Price</label>
                                                <input class="form-control" id="maxprice" type="text" placeholder="300000">
                                                <label for="state">Enter a Max Age of Home</label>
                                                <input class="form-control" id="maxage" type="text" placeholder="10">
                                                <label for="country">Minimum Number of Bathrooms</label>
                                                <input class="form-control" id="minbath" type="text" placeholder="1">
                                                <label for="shape">Minimum Number of Bedrooms</label>
                                                <input class="form-control" id="minbed" type="text" placeholder="1">
                                                <label for="sortpref"><h5>Sort Results:</h5></label>
                                                <input class="radioinput" name="sort" type="radio" value="relevance"><label class="radiolabel" for="relevance">Relevance</label>
                                                <input class="radioinput" name="sort" type="radio" value="newest"><label class="radiolabel" for="newest">Newest</label>
                                                <input class="radioinput" name="sort" type="radio" value="price_low"><label class="radiolabel" for="price_low">Lowest Price</label>
                                                <input class="radioinput" name="sort" type="radio" value="price_high"><label class="radiolabel" for="price_high">Highest Price</label></br></form>
                                                <label for="schoolsort"><h5>School Types:</h5></label>
                                                <input class="checkinput" id="schoolsort" type="checkbox" value="Highschool"><label for="relevance">High School</label>
                                                <input class="checkinput" id="schoolsort" type="checkbox" value="Middleschool"><label for="relevance">Middle school</label>
                                                <input class="checkinput" id="schoolsort" type="checkbox" value="Elementaryschool"><label for="relevance">Elementary School</label>
                                                <input class="checkinput" id="schoolsort" type="checkbox" value="k12"><label for="relevance">K12</label></form>
                                                </li>
                                            </ul>
                                        
                                        <button id="filter-btn" type="button" class="btn btn-default">Filter Homes</button></div>
                                        <button id="clear-btn" type="button" class="btn btn-default">Clear Markers</button></div>
                                    </form>
                                    </div>
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>
            </div></div>
        </div>
        <!-- This is our Javascript -->
        <!-- <canvas id="myCanvas"> -->
             <!-- d3 JavaScript -->
            <script src="https://d3js.org/d3.v6.min.js"></script>
            <div class="map float-right" id=map>
                <script></script>
            <script type="text/javascript">
            window.onload = function () {

            // // Step 1
            let map = createMap();
            addBaseLayer(map);
            // createBorough(map);


            function createMap() {
                // Creating map object
                let map = L.map("map", {
                center: [33.776108, -84.397530],
                zoom: 10,
                });
                return map;
            };

            // Step 2
            function addBaseLayer(map) {
                let baseLayer = L.tileLayer(
                "https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",
                {
                    attribution:
                    "© <a href='https://www.mapbox.com/about/maps/'>Mapbox</a> © <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a> <strong><a href='https://www.mapbox.com/map-feedback/' target='_blank'>Improve this map</a></strong>",
                    tileSize: 512,
                    maxZoom: 18,
                    zoomOffset: -1,
                    id: "mapbox/streets-v11",
                    accessToken: "pk.eyJ1IjoiZGFzc2Nvb3RlciIsImEiOiJja2pwdHZzNHoxMXlmMnhwZWZkaWp6d2xiIn0.zc1HfeVEMzRwCEm_glvbUQ",
                }
                );
                baseLayer.addTo(map);
            };

            // create markers for schools
            d3.json("/api/location", function(data) {
            for (var i = 0; i < data.length; i++) {
            let dataquery = data[i]
            let lat = dataquery.lat
            let lng = dataquery.lng
            let schoollocation = [lat, lng]
            console.log(schoollocation)
            L.marker(schoollocation)
            // .bindPopup("<h1>" + data[i][0] + "</h1> <hr> <h3>City: " + data[i][4] + "</h3>")
            .addTo(map)
            }

            // Realtor API Query
            // Realtor API jQuery Code provided code: https://rapidapi.com/apidojo/api/realtor?endpoint=apiendpoint_e259775d-d98e-479f-8440-206d6d4fa892   

            //Set up the Filter Button
            var button = d3.select("#filter-btn");
            button.on("click", runEnter);

            var clear = d3.select("#clear-btn")
            clear.on("click", runClear);

            function runClear() {
                //Clear current markers
                location.reload();
            };

            //Start Filter Function
            function runEnter() {

            //Assign variables based on the filter form
            let selectedcity = d3.select("#city").property("value")
            let limit = d3.select("#limit").property("value")
            let minbed = d3.select("#minbed").property("value")
            // Use this once we have the sort radios figured out
            let sort = d3.select('input[name=radioinput]:checked')
            let minbath = d3.select("#minbath").property("value")
            let maxprice = d3.select("#maxprice").property("value")
            let maxage = d3.select("#maxage").property("value")

            //Load Realtor.com API with Filter variables assigned in the call
            const settings = {
                "async": true,
                "crossDomain": true,
                // Use this URL when we have the Sort Drop Down/Radial Buttons figured out
                "url": `https://realtor.p.rapidapi.com/properties/v2/list-for-sale?city=
                        ${selectedcity}&limit=${limit}&offset=0&state_code=GA&beds_min=
                        ${minbed}&sort=${sort}&baths_min=${minbath}&price_max=${maxprice}
                        &age_max=${maxage}`,
                // "url": `https://realtor.p.rapidapi.com/properties/v2/list-for-sale?city=
                //         ${selectedcity}&limit=${limit}&offset=0&state_code=GA&beds_min=
                //         ${minbed}&sort=relevance&baths_min=${minbath}&price_max=${maxprice}&age_max=${maxage}`,
                "method": "GET",
                "headers": {
                "x-rapidapi-key": "a32cef4e7fmshe42c5a1bfdbce17p135b01jsn21abc1df2bea",
                "x-rapidapi-host": "realtor.p.rapidapi.com"
                }
            };

            //Process Realtor.com API through for loop and append listings to map markers
            $.ajax(settings).done(function (response) {
                let querydata = [response]
                var propertyquery = querydata[0].properties
            //Start Loop, set max length based on number of properties returned in search
                for (var i = 0; i < propertyquery.length; i++) {
                var property = propertyquery[i]
            //Define variables on each property
                let lat = property.address.lat
                let lng = property.address.lon
                let location = [lat, lng]
                let bedcount = property.beds
                let bathcount = property.baths
                let pricecount = property.price
                let weburl = property.rdc_web_url
                let street = property.address.line
                let city = property.address.city
                let state = property.address.state
                let zip = property.address.postal_code
            //Append coordinates to map and assign property variables in the pop up
                var marker = L.marker(location)
                .bindPopup("<h1>" + street + "</h1> <hr> <h3>" + city + "," + state + " " + zip + 
                            "</h3> <br> <h4>Beds: " + bedcount + "<br>Baths: " + bathcount + 
                            "<br>Price: " + pricecount + '<br><a href="' + weburl + '">See on Realtor.com</a>')
                .addTo(map);
                }
            });    
            }});
        </script></div>
        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>

        <!-- API key -->
        <script type="text/javascript" src="../js/config.js"></script>
        <!-- JS -->
        <script type="text/javascript" src="../js/map.js"></script>

        <!-- Google drawing function -->
        <!-- ####################REMOVE API BEFORE SUBMISSION api is between "="" and "&"" -->
        <script defer
           src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBziBa1em_bBCXGyYMJwelg4R-GnyMjgHE&libraries=drawing&callback=initMap">
        </script>


   
    </body>

</html>